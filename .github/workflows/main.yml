name: Toffee Auto Update Fix

on:
  schedule:
    - cron: '0 */5 * * *' # প্রতি ৫ ঘণ্টা পরপর
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Generate Files
        run: |
          python3 -c "
          import requests, json, datetime, os
          
          try:
              # ১. কুকি আনা
              res = requests.get('https://apis.allinonedev.top/tf/')
              new_cookie = res.json().get('set_cookie', '')
              
              if not new_cookie:
                  print('Cookie not found from API!')
                  exit(1)

              # ২. api.json চেক করা
              if not os.path.exists('api.json'):
                  print('api.json file missing in repository!')
                  exit(1)

              with open('api.json', 'r') as f:
                  channels = json.load(f)

              updated_on = datetime.datetime.now().strftime('%d-%m-%Y %I:%M:%S %p')
              
              tengo = {
                  'name': 'Toffee App All Channel Link with Headers',
                  'owner': 'Bd Coder Boy \nTelegram: https://t.me/fredflixceo',
                  'channels_amount': 0,
                  'updated_on': updated_on,
                  'channels': []
              }

              valid_channels = []
              ns_m3u = ''
              ott_m3u = '#EXTM3U\n'

              for ch in channels:
                  # ডাটা চেক: যদি নাম বা লিংক না থাকে তবে স্কিপ করবে
                  name = ch.get('name', 'Unknown Channel')
                  link = ch.get('link', '')
                  logo = ch.get('logo', '')
                  cat = ch.get('category_name', 'General') # category_name না থাকলে General ধরবে

                  if not link:
                      continue
                  
                  valid_channels.append({**ch, 'cookie': new_cookie})
                  host = link.split('//')[-1].split('/')[0] if '//' in link else 'mprod-cdn.toffeelive.com'
                  
                  # Tengo Structure
                  tengo['channels'].append({
                      'category_name': cat,
                      'name': name,
                      'link': link,
                      'headers': {
                          'Host': host,
                          'cookie': new_cookie,
                          'user-agent': 'Toffee (Linux;Android 14)',
                          'accept-encoding': 'gzip'
                      },
                      'logo': logo
                  })

                  # NS.M3U (Custom Format)
                  ns_m3u += f'#EXTINF:-1 group-title=\"{cat}\" tvg-logo=\"{logo}\", {name}\n#EXTVLCOPT:http-user-agent=Toffee (Linux;Android 14)\n#EXTVLCOPT:http-cookie={new_cookie}\n{link}\n'
                  
                  # OTT.M3U
                  ott_m3u += f'#EXTINF:-1 group-title=\"{cat}\" tvg-logo=\"{logo}\", {name}\n{link}|cookie={new_cookie}\n'

              tengo['channels_amount'] = len(tengo['channels'])
              ns_final = json.dumps(valid_channels, indent=2) + '\n\n#EXTM3U\n' + ns_m3u

              # ৩. ফাইল রাইট করা
              with open('tengo.json', 'w') as f: json.dump(tengo, f, indent=2)
              with open('ns.m3u', 'w') as f: f.write(ns_final)
              with open('ott.m3u', 'w') as f: f.write(ott_m3u)
              with open('channels.json', 'w') as f: json.dump(valid_channels, f, indent=2)
              
              print(f'Successfully updated {len(valid_channels)} channels!')
          except Exception as e:
              print(f'Critical Error: {e}')
              exit(1)
          "

      - name: Commit and Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto Update: $(date)" || echo "No changes"
          git push
