name: Toffee Link Auto Update

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Requests
        run: pip install requests

      - name: Execute Update
        run: |
          python3 -c "
          import requests, json, datetime, os
          def run():
              try:
                  res = requests.get('https://apis.allinonedev.top/tf/')
                  ck = res.json().get('set_cookie', '')
                  if not ck or not os.path.exists('api.json'): return
                  
                  with open('api.json', 'r') as f: channels = json.load(f)
                  
                  v_list, ns_str, ott_str = [], '', '#EXTM3U\n'
                  updated_time = datetime.datetime.now().strftime('%d-%m-%Y %I:%M:%S %p')
                  
                  tengo = {
                      'name': 'Toffee App All Channel Link with Headers',
                      'owner': 'Bd Coder Boy \nTelegram: https://t.me/fredflixceo',
                      'channels_amount': 0,
                      'updated_on': updated_time,
                      'channels': []
                  }

                  for ch in channels:
                      l = ch.get('link', '')
                      if not l: continue
                      n, lo, ct = ch.get('name', 'Live'), ch.get('logo', ''), ch.get('category_name', 'Premium')
                      h = l.split('//')[-1].split('/')[0] if '//' in l else ''
                      
                      v_list.append({**ch, 'cookie': ck})
                      
                      tengo['channels'].append({
                          'category_name': ct, 'name': n, 'link': l,
                          'headers': {'Host': h, 'cookie': ck, 'user-agent': 'Toffee (Linux;Android 14)', 'accept-encoding': 'gzip'},
                          'logo': lo
                      })

                      ns_str += f'#EXTINF:-1 group-title=\"{ct}\" tvg-logo=\"{lo}\", {n}\n#EXTVLCOPT:http-user-agent=Toffee (Linux;Android 14)\n#EXTVLCOPT:http-cookie={ck}\n{l}\n'
                      
                      # Kodi Type Structure for ott.m3u
                      ott_str += f'#EXTINF:-1 group-title=\"{ct}\" tvg-logo=\"{lo}\", {n}\n'
                      ott_str += f'#EXTVLCOPT:http-user-agent=Toffee (Linux;Android 14)\n'
                      ott_str += f'#EXTVLCOPT:http-cookie={ck}\n'
                      ott_str += f'{l}\n'

                  tengo['channels_amount'] = len(v_list)

                  with open('tengo.json', 'w') as f: json.dump(tengo, f, indent=2)
                  with open('ns.m3u', 'w') as f: f.write(json.dumps(v_list, indent=2) + '\n\n#EXTM3U\n' + ns_str)
                  with open('ott.m3u', 'w') as f: f.write(ott_str)
                  with open('channels.json', 'w') as f: json.dump(v_list, f, indent=2)
              except: pass
          run()
          "

      - name: Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "Update $(date)" || exit 0
          git push
