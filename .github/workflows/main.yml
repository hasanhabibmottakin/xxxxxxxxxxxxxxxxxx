name: Toffee Auto Update 5H

on:
  schedule:
    - cron: '0 */5 * * *' 
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Generate Files
        run: |
          python3 -c "
          import requests, json, datetime, os
          
          try:
            
              res = requests.get('https://apis.allinonedev.top/tf/')
              new_cookie = res.json().get('set_cookie', '')
              
              if not new_cookie:
                  print('Cookie not found!')
                  exit(1)

             
              with open('api.json', 'r') as f:
                  channels = json.load(f)

              updated_on = datetime.datetime.now().strftime('%d-%m-%Y %I:%M:%S %p')
              
              tengo = {
                  'name': 'Toffee App All Channel Link with Headers',
                  'owner': 'Bd Coder Boy \nTelegram: https://t.me/fredflixceo',
                  'channels_amount': len(channels),
                  'updated_on': updated_on,
                  'channels': []
              }

              ns_m3u = json.dumps([{**ch, 'cookie': new_cookie} for ch in channels], indent=2) + '\n\n#EXTM3U\n'
              ott_m3u = '#EXTM3U\n'

              for ch in channels:
                  host = ch['link'].split('//')[-1].split('/')[0]
                  tengo['channels'].append({
                      'category_name': ch['category_name'],
                      'name': ch['name'],
                      'link': ch['link'],
                      'headers': {'Host': host, 'cookie': new_cookie, 'user-agent': 'Toffee (Linux;Android 14)', 'accept-encoding': 'gzip'},
                      'logo': ch['logo']
                  })
                  ns_m3u += f'#EXTINF:-1 group-title=\"{ch[\"category_name\"]}\" tvg-logo=\"{ch[\"logo\"]}\", {ch[\"name\"]}\n#EXTVLCOPT:http-user-agent=Toffee (Linux;Android 14)\n#EXTVLCOPT:http-cookie={new_cookie}\n{ch[\"link\"]}\n'
                  ott_m3u += f'#EXTINF:-1 group-title=\"{ch[\"category_name\"]}\" tvg-logo=\"{ch[\"logo\"]}\", {ch[\"name\"]}\n{ch[\"link\"]}|cookie={new_cookie}\n'

             
              with open('tengo.json', 'w') as f: json.dump(tengo, f, indent=2)
              with open('ns.m3u', 'w') as f: f.write(ns_m3u)
              with open('ott.m3u', 'w') as f: f.write(ott_m3u)
              with open('channels.json', 'w') as f: json.dump([{**ch, 'cookie': new_cookie} for ch in channels], f, indent=2)
              print('Files generated successfully!')
          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          "

      - name: Commit and Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto Update: $(date)" || echo "No changes"
          git push
